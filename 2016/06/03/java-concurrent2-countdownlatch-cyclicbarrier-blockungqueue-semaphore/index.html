<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java并发编程之2——同步工具类的使用（CountDownLatch,CyclicBarrier,BlockungQueue,Semaphore） | 语言</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java并发编程之2——同步工具类的使用（CountDownLatch,CyclicBarrier,BlockungQueue,Semaphore）</h1><a id="logo" href="/.">语言</a><p class="description">编程是一种美德，是促使一个人不断向上发展的一种原动力. . .</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java并发编程之2——同步工具类的使用（CountDownLatch,CyclicBarrier,BlockungQueue,Semaphore）</h1><div class="post-meta">Jun 3, 2016<span> | </span><span class="category"><a href="/categories/Java/">Java</a><a href="/categories/Java/Java并发编程/">Java并发编程</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a href="/2016/06/03/java-concurrent2-countdownlatch-cyclicbarrier-blockungqueue-semaphore/#comments" class="ds-thread-count cloud-tie-join-count"><span style="font-size: 15px; color: #6E7173;" class="join-count">0</span><span> 条参与</span></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#闭锁（CountDownLatch）"><span class="toc-number">1.</span> <span class="toc-text">闭锁（CountDownLatch）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#栅栏（CyclicBarrier）"><span class="toc-number">2.</span> <span class="toc-text">栅栏（CyclicBarrier）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#阻塞队列（BlockingQueue）"><span class="toc-number">3.</span> <span class="toc-text">阻塞队列（BlockingQueue）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#信号量（Semaphore）"><span class="toc-number">4.</span> <span class="toc-text">信号量（Semaphore）</span></a></li></ol></div></div><div class="post-content"><p>为了简化线程同步与互斥的相关操作JDK，提供了大约4中同步与互斥的工具类： 闭锁（CountDownLatch），栅栏（CyclicBarrier），阻塞队列（BlockingQueue）,信号量（semaphore）。本文将对比分析四种同步工具类的使用范例，和应用场景。<a id="more"></a></p>
<h2 id="闭锁（CountDownLatch）"><a href="#闭锁（CountDownLatch）" class="headerlink" title="闭锁（CountDownLatch）"></a>闭锁（CountDownLatch）</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;闭锁的作用主要是允许一个或者多个线程等待某个事件的完成，当初始化一个CountDownLatch的时候需要指定同步计数器的个数（等待线程的个数），这个时候主线程的wait方法会一直阻塞，子线程每调用一次countDown方法，同步计数器就会减1,当这个值减少到0时，主线程的wait方法处就会解除阻塞。<br><strong>CountDownLatch的主要方法如下：</strong></p>
<ul>
<li>public CountDownLatch(int count);   //构造函数 传入一个同步计数器 当同步计数器大于0的时候主线程调用wait的地方会一直阻塞</li>
<li>public void countDown();  //当子线程调用一次countDown方法的时候同步计数器的数值就会减1</li>
<li>public void await() throws InterruptedException //当同步计数器的数值大于0的时候，主线程会一直在wait方法处等待，当同步计数器的大小为0的时候，主线程就会解除阻塞继续运行。</li>
</ul>
<p><strong>CountDownLatch示例：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.qunar.des.current;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by chenglaiguo on 7/21/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CountDownLatchTest.class);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">3</span>);<span class="comment">//构造函数传入3个同步计数器</span></div><div class="line"></div><div class="line">        System.out.println(<span class="string">"CountDownLatchTest begin ..."</span>);</div><div class="line">        <span class="keyword">new</span> Worker(<span class="string">"zs"</span>,countDownLatch).start(); <span class="comment">//启动3个线程，</span></div><div class="line">        <span class="keyword">new</span> Worker(<span class="string">"ls"</span>,countDownLatch).start();</div><div class="line">        <span class="keyword">new</span> Worker(<span class="string">"ww"</span>,countDownLatch).start();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            countDownLatch.await(); <span class="comment">// 当同步计数器的数值大于0的时候，线程会一直在这里等待，不会执行下面的sysout，当两个子线程执行完成后同步计数器数值减到0,主线程会继续执行</span></div><div class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">            logger.error(<span class="string">"CountDownLatchTest await cause InterruptedException : "</span>,e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"CountDownLatchTest end ..."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> String name;</div><div class="line">        <span class="keyword">private</span> CountDownLatch countDownLatch;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(String name,CountDownLatch countDownLatch)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">            <span class="keyword">this</span>.countDownLatch = countDownLatch;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.currentThread().sleep(<span class="number">1000</span>);</div><div class="line">                System.out.println(name+<span class="string">"complete his work..."</span>);</div><div class="line">                countDownLatch.countDown();  <span class="comment">// 当子线程执行完成之后，每调用一个countDown()方法，程序计数器的数值就会减1</span></div><div class="line"></div><div class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                logger.error(<span class="string">"Worker run method cause InterruptedException : "</span>,e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>CountDownLatch的适用场景：</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;主线程在做一项工作之前需要一系列准备工作，只有这些准备工作都完成之后，主线程才能继续他的工作，而这些准备工作之间是相互独立的。例如  我们的搜索系统，在启动是时候主要有两部分的工作：</p>
<ul>
<li>准备数据</li>
<li>建立数据之间的关联关系<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在建立数据关系之前数据的准备必须完成，而大部分的数据之间是相互独立的，所以可以分一些子任务并发运行，当所有的子任务运行完成之后，就可以建立数据关系</li>
</ul>
<h2 id="栅栏（CyclicBarrier）"><a href="#栅栏（CyclicBarrier）" class="headerlink" title="栅栏（CyclicBarrier）"></a>栅栏（CyclicBarrier）</h2><p><strong>栅栏的主要作用是等待其他线程的完成，他CountDownLatch的主要区别是:</strong> </p>
<p><font color="red"></font></p>
<ul>
<li>CountDownLatch主要是等待事件的完成，每个子线程只能countDown()一次，当子线程调用一次countDown方法,就表示当前线程的事件完成。（子线程之间不是相互等待，子线程完成之后在主线程的wait处等待）</li>
<li>CyclicBarrier主要是等待其他的线程完成（所有的子线程之间会相互等待，主线程的流程不会受到子线程的影响）。他的主要方法是一个await(),这个方法每被调用一次计数器便会减1,并阻塞住当前的线程，当计数减到0的时候，阻塞会解除，在这个栅栏上面等待的所有线程都会继续运行。然后进行一次新的循环（这时如果是CountDownLatch会回到主线程运行，而不是唤醒所有在栅栏上面等待的子线程继续运行）<br><br><strong>CyclicBarrier的主要方法：</strong></li>
<li>await() 这个方法每被调用一次计数器便会减1,并阻塞住当前的线程，当计数减到0的时候，阻塞会解除，在这个栅栏上面等待的所有线程都会继续运行。然后进行一次新的循环。</li>
</ul>
<p><strong>CyclicBarrier示例：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.qunar.des.current;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.CyclicBarrier;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by chenglaiguo on 7/24/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CyclicBarrierTest.class);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">3</span>);</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"cyclicBarrierTest begin..."</span>);</div><div class="line">        <span class="keyword">new</span> Runner(cyclicBarrier,<span class="string">"zs"</span>).start();  <span class="comment">// 启动三个子线程</span></div><div class="line">        <span class="keyword">new</span> Runner(cyclicBarrier,<span class="string">"ls"</span>).start();</div><div class="line">        <span class="keyword">new</span> Runner(cyclicBarrier,<span class="string">"ww"</span>).start();</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"cyclicBarrierTest end ...."</span>);  <span class="comment">//主线程不会阻塞，所以启动子线程之后，这里会马上执行</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Runner</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> CyclicBarrier cyclicBarrier ;</div><div class="line">        <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Runner</span><span class="params">(CyclicBarrier cyclicBarrier,String name)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.cyclicBarrier = cyclicBarrier;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.currentThread().sleep(<span class="number">1000</span>);</div><div class="line">                System.out.println(name+<span class="string">": is ready...."</span>);</div><div class="line">                cyclicBarrier.await(); <span class="comment">// 三个子线程会在这里进行第一步的等待 （与主线程无关）当三个子线程都执行完成之后，会同时进行下一步的工作</span></div><div class="line"></div><div class="line">                Thread.currentThread().sleep(<span class="number">1000</span>);</div><div class="line">                System.out.println(name+<span class="string">": is running..."</span>);</div><div class="line">                cyclicBarrier.await(); <span class="comment">// 三个子线程会在这里进行第二步的等待（与主线程无关）当三个子线程都执行完成之后，会同时进入下一步的操作</span></div><div class="line"></div><div class="line">                Thread.currentThread().sleep(<span class="number">1000</span>);</div><div class="line">                System.out.println(name+<span class="string">": is complete..."</span>); <span class="comment">//执行完成之后，子线程退出</span></div><div class="line"></div><div class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">                logger.error(<span class="string">"Runner run method cause exception : "</span>,e);</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="阻塞队列（BlockingQueue）"><a href="#阻塞队列（BlockingQueue）" class="headerlink" title="阻塞队列（BlockingQueue）"></a>阻塞队列（BlockingQueue）</h2><p><strong>BlockingQueue是Java提供的一种阻塞队列实现方式，他主要有四种实现：</strong></p>
<ul>
<li>ArrayBlockingQueue  有界的阻塞队列，在实例化的时候需要指明有界队列的大小，队列采用先进先出的策略</li>
<li>LinkedBlockQueue  有两种构造方法默认的是不传递任何参数，这种方式是一个无界的阻塞队列，另一种方式和ArrayBlockingQueue相同</li>
<li>SynchronousBlockQueue 比较特殊（所有的读写操作都是读取交替运行才可以）</li>
<li>PriorityBolckQueue 有优先级的阻塞队列<br><strong>阻塞队列的主要方法（以ArrayBlockingQueue为列子说明）：</strong></li>
<li>piblic  ArrayBlockQueue(int count) 构造方法制定阻塞队列的大小</li>
<li>piblic void put() 方法在队列满的时候会阻塞直到有队列成员被消费，</li>
<li>public T take() 方法在队列空的时候会阻塞，直到有队列成员被放进来</li>
</ul>
<p><strong>BlockingQueue示例：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.qunar.des.current;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by chenglaiguo on 7/24/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingQueueTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(BlockingQueueTest.class);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        BlockingQueue&lt;String&gt; blockingQueue = <span class="keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="number">5</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</div><div class="line">            <span class="keyword">new</span> Consumer(blockingQueue).start();</div><div class="line">            <span class="keyword">new</span> Producer(blockingQueue).start();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> BlockingQueue&lt;String&gt; blockingQueue;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.blockingQueue = blockingQueue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.currentThread().sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</div><div class="line">                String product = blockingQueue.take();  <span class="comment">//如果队列为空 当前线程会在这里阻塞</span></div><div class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">" : consumer : "</span>+product);</div><div class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                logger.error(<span class="string">"Consumer run method cause InterruptedException"</span>,e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> BlockingQueue&lt;String&gt; blockingQueue;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.blockingQueue = blockingQueue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.currentThread().sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</div><div class="line">                String productName = <span class="string">"product"</span>+<span class="keyword">new</span> Random().nextInt(<span class="number">1000000</span>);</div><div class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">"  : produce :"</span>+productName);</div><div class="line">                blockingQueue.put(productName); <span class="comment">//如果队列已经满了当前线程会在这里阻塞</span></div><div class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                logger.error(<span class="string">"Producer run method cause InterruptedException"</span>,e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="信号量（Semaphore）"><a href="#信号量（Semaphore）" class="headerlink" title="信号量（Semaphore）"></a>信号量（Semaphore）</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;信号量通过构造函数设定一个数量的许可（permit）,然后通过acquire获取许可，通过release释放许可，当acquire获取到许可之后当前的线程就可以执行，否则当前线程阻塞。Semaphore通常用于限制可以访问资源的数量，例如数据库连接池，线程池。单个信号量的semaphore可以用来实现互斥锁<br><strong>Semaphore的主要方法如下：</strong></p>
<ul>
<li>Semaphore(int permits, boolean fair) //创建具有给定的许可数和给定的公平设置的Semaphore。  如果以公平方式执行，则线程将会按到达的顺序（FIFO）执行，如果是非公平，则可以后请求的有可能排在队列的头部</li>
<li>acquire() 获取一个许可，如果没有就等待,当前线程阻塞直到获取到许可之后才会继续执行</li>
<li>release() 释放一个许可。</li>
</ul>
<p><strong>Semaphore示例：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.qunar.des.current;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.Semaphore;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by chenglaiguo on 7/24/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(SemaphoreTest.class);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        DataPool dataPool = <span class="keyword">new</span> DataPool();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;  <span class="comment">//100个线程获取10个链接，可以演示他们的同步与阻塞</span></div><div class="line">             <span class="keyword">new</span> ConnectionConsumer(dataPool).start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionConsumer</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        DataPool dataPool ;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ConnectionConsumer</span><span class="params">(DataPool dataPool)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.dataPool = dataPool;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Object connection = dataPool.acquireDataConnection(); <span class="comment">//获取链接</span></div><div class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">"  acquire "</span>+connection.toString());</div><div class="line"></div><div class="line">                Thread.currentThread().sleep(<span class="number">1000</span>); <span class="comment">//消费链接</span></div><div class="line"></div><div class="line">                dataPool.releaseDataConnection(); <span class="comment">//释放链接</span></div><div class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">"  release "</span>+connection.toString());</div><div class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                logger.error(<span class="string">"ConnectionConsumer run cause InterruptedException : "</span>,e);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DataPool</span></span>&#123;   <span class="comment">//在这里模拟一个容量为10的数据库连接池</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMIT_COUNT = <span class="number">10</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Semaphore dataPoolSize = <span class="keyword">new</span> Semaphore(PERMIT_COUNT,<span class="keyword">true</span>);  <span class="comment">//使用公平的信号量，这个信号量中有10个许可</span></div><div class="line">        <span class="keyword">private</span> Object[] allDataConnection = <span class="keyword">new</span> Object[PERMIT_COUNT];</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span>[] isUsed = <span class="keyword">new</span> <span class="keyword">boolean</span>[PERMIT_COUNT];</div><div class="line"></div><div class="line">        DataPool() &#123;  <span class="comment">//初始化10个数据库链接池</span></div><div class="line">            allDataConnection[<span class="number">0</span>]=<span class="string">"connection 1"</span>;</div><div class="line">            allDataConnection[<span class="number">1</span>]=<span class="string">"connection 2"</span>;</div><div class="line">            allDataConnection[<span class="number">2</span>]=<span class="string">"connection 3"</span>;</div><div class="line">            allDataConnection[<span class="number">3</span>]=<span class="string">"connection 4"</span>;</div><div class="line">            allDataConnection[<span class="number">4</span>]=<span class="string">"connection 5"</span>;</div><div class="line">            allDataConnection[<span class="number">5</span>]=<span class="string">"connection 6"</span>;</div><div class="line">            allDataConnection[<span class="number">6</span>]=<span class="string">"connection 7"</span>;</div><div class="line">            allDataConnection[<span class="number">7</span>]=<span class="string">"connection 8"</span>;</div><div class="line">            allDataConnection[<span class="number">8</span>]=<span class="string">"connection 9"</span>;</div><div class="line">            allDataConnection[<span class="number">9</span>]=<span class="string">"connection 10"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">acquireDataConnection</span><span class="params">()</span></span>&#123; <span class="comment">//获取一个数据库链接</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                dataPoolSize.acquire();  <span class="comment">//首先获取一个信号量的许可，如果当前线程获取到了许可则当前线程可以继续执行，如果当前线程没有获取到许可，则当前线程会阻塞等待</span></div><div class="line">            &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                logger.error(<span class="string">"DataPool getDataConnection cause InterruptedException : "</span>,e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> acquireAvailableDataConnection(); <span class="comment">// 如果当前线程获取到一个信号量的许可之后，就可以获取到一个链接</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseDataConnection</span><span class="params">()</span></span>&#123; <span class="comment">// 释放一个许可，注意：这里是在连接池中任意找到一个链接释放，在实际开发中需要释放的线程应该和释放信号量的那个线程占有的链接是同一个 （这里是简化做法，可能释放其他线程占有的链接）</span></div><div class="line">            dataPoolSize.release();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;PERMIT_COUNT;i++)&#123;</div><div class="line">                <span class="keyword">if</span> (isUsed[i])&#123; <span class="comment">// 找到一个被占有的链接释放</span></div><div class="line">                    isUsed[i]=<span class="keyword">false</span>;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> Object <span class="title">acquireAvailableDataConnection</span><span class="params">()</span></span>&#123; <span class="comment">// 当一个线程获取到信号量之后，就可以找到一个没有使用的链接返回</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;PERMIT_COUNT;i++)&#123;</div><div class="line">                <span class="keyword">if</span> (!isUsed[i])&#123; <span class="comment">//返回一个未被使用的链接</span></div><div class="line">                    isUsed[i]=<span class="keyword">true</span>;</div><div class="line">                    <span class="keyword">return</span> allDataConnection[i];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://guochenglai.com/2016/06/03/java-concurrent2-countdownlatch-cyclicbarrier-blockungqueue-semaphore/" data-id="cj3iubhwb001r5hbgo8wn4l50" class="article-share-link">分享</a><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/并发编程/">并发编程</a><a href="/tags/CountDownLatch/">CountDownLatch</a><a href="/tags/CyclicBarrier/">CyclicBarrier</a><a href="/tags/Semaphore/">Semaphore</a></div><div class="post-nav"><a href="/2016/06/03/java-concurrent3-java-lock-intro/" class="pre">java并发编程之3——Java锁的分析</a><a href="/2016/06/02/java-concurrent1-synchronized-volatile/" class="next">java并发编程之1——synchronized和volatile</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script>var cloudTieConfig = {
  url: document.location.href,
  productKey: "4e7d0025e59f4202ad52afa122a96a8a",
  target: "cloud-tie-wrapper"
};</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://guochenglai.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Guava教程/">Guava教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Java命令工具/">Java命令工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Java并发编程/">Java并发编程</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Java并发编程/源码分析/">源码分析</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux常用技巧/">Linux常用技巧</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac常用技巧/">Mac常用技巧</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Mac常用技巧/软件破解/">软件破解</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/字符编码/">字符编码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构面试精选/">数据结构面试精选</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/gcl272633743" title="我的CSDN博客" target="_blank">我的CSDN博客</a><ul></ul><a href="https://github.com/guochenglai/guochenglai.github.io" title="我的GitHub" target="_blank">我的GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">语言.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>