<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>InputStream读取问题 | 语言</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-78419105-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">InputStream读取问题</h1><a id="logo" href="/.">语言</a><p class="description">编程是一种美德，是促使一个人不断向上发展的一种原动力. . .</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">InputStream读取问题</h1><div class="post-meta">Oct 30, 2016<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-thread-key="2016/10/30/inputstream-to-byte/" href="/2016/10/30/inputstream-to-byte/#comments" class="ds-thread-count"></a><div class="post-content"><p>最近写了一个项目，需要将HTTP请求的数据读取到一个byte数组中。我的写法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//下面这段代码想做到的功能大概是：先获取inputStream中数据内容的大小。然后实例化一个数组。最后将所有的数据内容读取到这个数组之中。  </span></div><div class="line"></div><div class="line"><span class="keyword">try</span> (InputStream inputStream = httpResponse.getEntity().getContent()) &#123;  </div><div class="line">            <span class="keyword">int</span> size = inputStream.available();  </div><div class="line">            <span class="keyword">byte</span>[] dataContent = <span class="keyword">new</span> <span class="keyword">byte</span>[size];  </div><div class="line">            inputStream.read(dataContent);  </div><div class="line">            <span class="keyword">return</span> dataContent;  </div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">    logger.error(<span class="string">"download qrcode cause exception"</span>, e);  </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码看起来没什么问题。但是最后测试的时候，总是发现数据和想象中的不一样。搜了好久也没有看到解决方案，于是决定去看Java中InputStream的代码，这个代码其实有两个错误的地方。分别是对available函数和read函数的理解。下面我们看看Java源代码中对着两个函数的解释。 </p>
<p>首先看看available()函数  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**  </span></div><div class="line">     * Returns an estimate of the number of bytes that can be read (or  </div><div class="line">     * skipped over) from this input stream without blocking by the next  </div><div class="line">     * invocation of a method for this input stream. The next invocation  </div><div class="line">     * might be the same thread or another thread.  A single read or skip of this  </div><div class="line">     * many bytes will not block, but may read or skip fewer bytes.  </div><div class="line">     *  </div><div class="line">     * &lt;p&gt; Note that while some implementations of &#123;<span class="doctag">@code</span> InputStream&#125; will return  </div><div class="line">     * the total number of bytes in the stream, many will not.  It is  </div><div class="line">     * never correct to use the return value of this method to allocate  </div><div class="line">     * a buffer intended to hold all data in this stream.  </div><div class="line">     *  </div><div class="line">     * &lt;p&gt; A subclass' implementation of this method may choose to throw an  </div><div class="line">     * &#123;<span class="doctag">@link</span> IOException&#125; if this input stream has been closed by  </div><div class="line">     * invoking the &#123;<span class="doctag">@link</span> #close()&#125; method.  </div><div class="line">     *  </div><div class="line">     * &lt;p&gt; The &#123;<span class="doctag">@code</span> available&#125; method for class &#123;<span class="doctag">@code</span> InputStream&#125; always  </div><div class="line">     * returns &#123;<span class="doctag">@code</span> 0&#125;.  </div><div class="line">     *  </div><div class="line">     * &lt;p&gt; This method should be overridden by subclasses.  </div><div class="line">     *  </div><div class="line">     * <span class="doctag">@return</span>     an estimate of the number of bytes that can be read (or skipped  </div><div class="line">     *             over) from this input stream without blocking or &#123;<span class="doctag">@code</span> 0&#125; when  </div><div class="line">     *             it reaches the end of the input stream.  </div><div class="line">     * <span class="doctag">@exception</span>  IOException if an I/O error occurs.  </div><div class="line">     */  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">available</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;  </div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//这里可以看到available函数默认值返回的是0，可能具体的实现方式返回的数值不同，但是可以肯定的一点是。这里返回的不是HTTP请求所获取的总数据的长度。  </span></div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上面的注释的意思大概是，这个函数返回一个从inputStream中获取数据的估计值（注意不是精确值）。这个值也可能是0。一般情况下不是数据的总量。 </p>
<p>再看看read()函数 </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**  </span></div><div class="line"> * Reads some number of bytes from the input stream and stores them into  </div><div class="line"> * the buffer array &lt;code&gt;b&lt;/code&gt;. The number of bytes actually read is  </div><div class="line"> * returned as an integer.  This method blocks until input data is  </div><div class="line"> * available, end of file is detected, or an exception is thrown.  </div><div class="line"> *  </div><div class="line"> * &lt;p&gt; If the length of &lt;code&gt;b&lt;/code&gt; is zero, then no bytes are read and  </div><div class="line"> * &lt;code&gt;0&lt;/code&gt; is returned; otherwise, there is an attempt to read at  </div><div class="line"> * least one byte. If no byte is available because the stream is at the  </div><div class="line"> * end of the file, the value &lt;code&gt;-1&lt;/code&gt; is returned; otherwise, at </div><div class="line"> * least one byte is read and stored into &lt;code&gt;b&lt;/code&gt;.  </div><div class="line"> *  </div><div class="line"> * &lt;p&gt; The first byte read is stored into element &lt;code&gt;b[0]&lt;/code&gt;, the  </div><div class="line"> * next one into &lt;code&gt;b[1]&lt;/code&gt;, and so on. The number of bytes read is,  </div><div class="line"> * at most, equal to the length of &lt;code&gt;b&lt;/code&gt;. Let &lt;i&gt;k&lt;/i&gt; be the  </div><div class="line"> * number of bytes actually read; these bytes will be stored in elements  </div><div class="line"> * &lt;code&gt;b[0]&lt;/code&gt; through &lt;code&gt;b[&lt;/code&gt;&lt;i&gt;k&lt;/i&gt;&lt;code&gt;-1]&lt;/code&gt;,  </div><div class="line"> * leaving elements &lt;code&gt;b[&lt;/code&gt;&lt;i&gt;k&lt;/i&gt;&lt;code&gt;]&lt;/code&gt; through  </div><div class="line"> * &lt;code&gt;b[b.length-1]&lt;/code&gt; unaffected.  </div><div class="line"> *  </div><div class="line"> * &lt;p&gt; The &lt;code&gt;read(b)&lt;/code&gt; method for class &lt;code&gt;InputStream&lt;/code&gt;  </div><div class="line"> * has the same effect as: &lt;pre&gt;&lt;code&gt; read(b, 0, b.length) &lt;/code&gt;&lt;/pre&gt;  </div><div class="line"> *  </div><div class="line"> * <span class="doctag">@param</span>      b   the buffer into which the data is read.  </div><div class="line"> * <span class="doctag">@return</span>     the total number of bytes read into the buffer, or  </div><div class="line"> *             &lt;code&gt;-1&lt;/code&gt; if there is no more data because the end of  </div><div class="line"> *             the stream has been reached.  </div><div class="line"> * <span class="doctag">@exception</span>  IOException  If the first byte cannot be read for any reason  </div><div class="line"> * other than the end of the file, if the input stream has been closed, or  </div><div class="line"> * if some other I/O error occurs.  </div><div class="line"> * <span class="doctag">@exception</span>  NullPointerException  if &lt;code&gt;b&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;. </div><div class="line"> * <span class="doctag">@see</span>        java.io.InputStream#read(byte[], int, int)  </div><div class="line"> */  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span> b[])</span> <span class="keyword">throws</span> IOException </span>&#123;  </div><div class="line"></div><div class="line">    <span class="keyword">return</span> read(b, <span class="number">0</span>, b.length);  </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>read函数的解释是读取byte数组中的内容，能够读取到多少就读取多少。将实际读取的内容存放在byte数组中。 所以这里也不是你传递数据大小是多少就读取多少的内容。<br>。分析到这里相信大家明白了我上述例子中代码的问题。那么要实现这个功能有没有比较简单的方法呢？其实是有的。很多的工具类都提供了这个解决方案。例如Apache和Guava。下面提供一种guava的实现方案。具体的实现我就不分析了，有兴趣可以去看看guava的源代码。 </p>
<p>guava的实现：<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line"><span class="keyword">try</span> (InputStream inputStream = httpResponse.getEntity().getContent()) &#123;  </div><div class="line"></div><div class="line">           <span class="keyword">byte</span>[] dataContent = ByteStreams.toByteArray(inputStream);  </div><div class="line"></div><div class="line">           <span class="keyword">return</span> dataContent;  </div><div class="line"></div><div class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line"></div><div class="line">           logger.error(<span class="string">"download qrcode cause exception"</span>, e);  </div><div class="line"></div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/Java/">Java</a></div><div class="post-nav"><a href="/2017/01/22/mac-software-shortcut/" class="pre">mac软件设置启动快捷键</a><a href="/2016/10/14/linux-find-deleted-file/" class="next">Linux恢复误删除的文件</a></div><div data-thread-key="2016/10/30/inputstream-to-byte/" data-title="InputStream读取问题" data-url="http://guochenglai.com/2016/10/30/inputstream-to-byte/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/10/30/inputstream-to-byte/" data-title="InputStream读取问题" data-url="http://guochenglai.com/2016/10/30/inputstream-to-byte/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Guava教程/">Guava教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Java命令工具/">Java命令工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Java并发编程/">Java并发编程</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Java并发编程/源码分析/">源码分析</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux常用技巧/">Linux常用技巧</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac常用技巧/">Mac常用技巧</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Mac常用技巧/软件破解/">软件破解</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/字符编码/">字符编码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构面试精选/">数据结构面试精选</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/javafx-deploy-exe-dmg-file/">javafx打包为执行的exe/dmg文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/13/java-concurrent11-future-listenablefuture/">java并发编程之11——Future/ListenableFuture</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/09/java-syntactic-sugar/">Java语法糖</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/07/tomcat-encoding/">Tomcat对URI和Parameter中文字符解码详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/06/apple-script-guide/">AppleScript简明教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/04/sublime-guide/">sublime3技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/03/pac-backup/">pac-backup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/28/mac-auto-proxy/">使用Alfred Workflow 自动切换网络和代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/22/mac-software-shortcut/">mac软件设置启动快捷键</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/30/inputstream-to-byte/">InputStream读取问题</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/gcl272633743" title="我的CSDN博客" target="_blank">我的CSDN博客</a><ul></ul><a href="https://github.com/guochenglai/guochenglai.github.io" title="我的GitHub" target="_blank">我的GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">语言.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script>var duoshuoQuery = {short_name:'guochenglai'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?dddca6123bb9b862f15d6a9178ad4a2d";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>